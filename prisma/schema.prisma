generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String    @id @default(uuid())
  firstName  String
  lastName   String
  email      String    @unique
  password   String
  image      String
  telegramId String?   @unique
  phone      String?   @unique
  role       RoleUser  @default(STUDENT)
  isActive   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updateAt   DateTime  @updatedAt
  comments   Comment[]
  likes      Likes[]
  results    Result[]
  stars      Stars[]
  tests      Test[]
}

model TestCategory {
  id           String   @id @default(uuid())
  categoryName String   @unique
  image        String
  createdAt    DateTime @default(now())
  updateAt     DateTime @updatedAt
  tests        Test[]
}

model Test {
  id           String         @id @default(uuid())
  title        String
  description  String
  categoryId   String
  teacherId    String
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updateAt     DateTime       @updatedAt
  comments     Comment[]
  likes        Likes[]
  questions    Question[]
  results      Result[]
  stars        Stars[]
  category     TestCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  Teacher      User           @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  testVariants TestVariants[]
}

model Result {
  id            String         @id @default(uuid())
  studentId     String
  testId        String
  variantId     String
  score         Int?
  completed_at  DateTime       @default(now())
  createdAt     DateTime       @default(now())
  updateAt      DateTime       @default(now())
  status        ResultStatus   @default(IN_PROGRESS)
  student       User           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  test          Test           @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant       TestVariants   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  resultAnswers ResultAnswer[]
}

model TestVariants {
  id        String   @id @default(uuid())
  testId    String
  name      String
  createdAt DateTime @default(now())
  updateAt  DateTime @updatedAt
  results   Result[]
  test      Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model Options {
  id            String         @id @default(uuid())
  questionId    String
  optionText    String
  isCorrect     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updateAt      DateTime       @updatedAt
  question      Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  resultAnswers ResultAnswer[]
}

model Question {
  id            String         @id @default(uuid())
  testId        String
  questionText  String
  createdAt     DateTime       @default(now())
  updateAt      DateTime       @updatedAt
  options       Options[]
  test          Test           @relation(fields: [testId], references: [id], onDelete: Cascade)
  resultAnswers ResultAnswer[]
}

model ResultAnswer {
  id             String    @id @default(uuid())
  resultId       String
  questionId     String
  selectOptionId String?
  isCorrect      IsCorrect @default(PENDING)
  answerAt       DateTime  @default(now())
  createdAt      DateTime  @default(now())
  question       Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  result         Result    @relation(fields: [resultId], references: [id], onDelete: Cascade)
  selectOption   Options?  @relation(fields: [selectOptionId], references: [id], onDelete: Cascade)
}

model Stars {
  id        String   @id @default(uuid())
  studentId String
  testId    String
  stars     Float
  createdAt DateTime @default(now())
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  test      Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([studentId, testId])
}

model Comment {
  id          String   @id @default(uuid())
  studentId   String
  testId      String
  commentText String
  createdAt   DateTime @default(now())
  updateAt    DateTime @updatedAt
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  test        Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model Likes {
  id        String   @id @default(uuid())
  studentId String
  testId    String
  isLike    Boolean
  createdAt DateTime @default(now())
  updateAt  DateTime @updatedAt
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  test      Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
}

enum ResultStatus {
  IN_PROGRESS
  FINISHED
  TIMEOUT
}

enum IsCorrect {
  PENDING
  CORRECT
  WRONG
}

enum RoleUser {
  ADMIN
  STUDENT
  TEACHER
}
